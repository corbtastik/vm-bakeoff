# VM Bakeoff: Lima (VZ) + Ubuntu (Apple Silicon) + Per-VM Provisioning üß™üçè

This repo is a **VM bakeoff framework** for running Linux VMs on **Apple Silicon macOS** using **Lima + Virtualization.framework (VZ)** ‚Äî with a clean separation between:

- **VM lifecycle** (create/start/stop/destroy, disks, port-forwards)
- **Software provisioning** (MongoDB, Postgres, Nginx, etc.)

The goal is to manage **multiple independent VMs** safely:
- No accidental shared disks
- No ‚Äúone VM running everything‚Äù
- Manual, per-VM ‚Äúoffset style‚Äù host port forwards to avoid collisions

> Blog Post (original): VMs on macOS (Apple Silicon) with Lima ‚Äî https://corbs.io/

---

## What you get ‚úÖ

### VM lifecycle per `VM=<name>`
Each VM is managed independently:

- VM name pattern: `<vm>-vz` (e.g. `mongodb-vz`, `postgres-vz`)
- Disk name pattern: `<vm>-data` (e.g. `mongodb-data`, `postgres-data`)
- Port forwards are defined per VM (manual mapping)

### Provisioning per service
Provisioning is explicit and modular:

- `make provision-mongodb VM=mongodb`
- `make provision-postgres VM=postgres`
- `make provision-nginx VM=nginx`

### Disks are safe by default
`make destroy VM=mongodb` deletes:
- the VM **and**
- its associated named Lima disk (unless you opt out)

> Escape hatch: `KEEP_DISK=1 make destroy VM=mongodb`

---

## Repo structure üìÅ

```text
vm-bakeoff/
  Makefile
  drivers/
    lima.sh

  platforms/
    lima/
      images/
        ubuntu.env            # pinned Ubuntu image URL + SHA256 digest (generated by ubuntu-pin)
      vms/
        <vm>.yaml             # generated per VM (gitignored)

  vms/
    mongodb.env               # VM config (cpu/mem/disks/ports) for mongodb VM
    postgres.env              # VM config for postgres VM
    nginx.env                 # VM config for nginx VM (can be diskless)

  software/
    mongodb.env               # software defaults for MongoDB provisioning
    postgres.env              # software defaults for Postgres provisioning
    nginx.env                 # software defaults for Nginx provisioning

  scripts/
    ubuntu-pin.sh             # pin Ubuntu image + digest once
    lima-gen-yaml.sh          # generate per-VM Lima YAML from vms/<vm>.env

    up.sh
    down.sh
    destroy.sh
    status.sh
    ssh.sh
    endpoints.sh
    run.sh                    # optional convenience runner

    provision-mongodb.sh      # host wrapper -> pipes guest script into VM
    provision-postgres.sh
    provision-nginx.sh

    guest/
      provision-mongodb.sh    # runs inside guest
      provision-postgres.sh
      provision-nginx.sh
```

---

## Prereqs on macOS ‚úÖ

* Homebrew
* Lima (`limactl`)
* HTTPie (for deterministic pin scripts)

Install:

```bash
brew install lima httpie
```

Check:

```bash
limactl --version
```

---

## Quickstart (MongoDB VM) üçÉ

### 1) Pin Ubuntu image digest (deterministic)

Generates `platforms/lima/images/ubuntu.env`:

```bash
make ubuntu-pin
```

### 2) Start the MongoDB VM

Creates/starts `mongodb-vz`, ensures disk `mongodb-data`, generates `platforms/lima/vms/mongodb.yaml`:

```bash
make up VM=mongodb
make status VM=mongodb
make ssh VM=mongodb
```

### 3) Provision MongoDB inside the VM

```bash
make provision-mongodb VM=mongodb
make endpoints VM=mongodb
```

### 4) Stop / Destroy

Stop:

```bash
make down VM=mongodb
```

Destroy **VM + disk**:

```bash
make destroy VM=mongodb
```

Keep disk but delete VM:

```bash
KEEP_DISK=1 make destroy VM=mongodb
```

---

## Quickstart (Postgres VM) üêò

```bash
make ubuntu-pin
make up VM=postgres
make provision-postgres VM=postgres
make endpoints VM=postgres
make down VM=postgres
make destroy VM=postgres
```

---

## VM configuration (single place) ‚öôÔ∏è

Each VM has a config file:

* `vms/mongodb.env`
* `vms/postgres.env`
* `vms/nginx.env`

These define:

* `VM_NAME` (defaults to `<vm>-vz`)
* CPU/Mem/root disk
* optional data disk (`HAS_DATA_DISK=1|0`)
* per-VM port forwards via manual `FORWARDS="guest:host guest:host"`

Example:

```bash
FORWARDS="27017:37017"
```

This means:

* guest 27017 ‚Üí host 37017

---

## Software configuration (separate place) üß©

Software-specific defaults live in:

* `software/mongodb.env`
* `software/postgres.env`
* `software/nginx.env`

Provision scripts load:

1. VM config (disk/ports/etc.)
2. software config (versions/users/db names)

That keeps VM lifecycle cleanly separated from installed software.

---

## Notes on security üîê

* MongoDB is configured to bind to `127.0.0.1` inside the VM by default.
* Postgres likewise binds to `127.0.0.1`.
* Host access should be through port forwards using offset ports (e.g. `37017`, `35432`) to reduce collisions.

---

## Generated files / gitignore üßπ

* Per-VM yamls under `platforms/lima/vms/` are generated and **gitignored**
* Pinned image digest (`platforms/lima/images/ubuntu.env`) can be tracked or regenerated ‚Äî your choice

---

## License

MIT (or your preference)

---

I love it. Now I had previously wrote a blog post. I'm going to paste it here. I want you to redo it in the same spirit, keep the tutorial flow, but speak to the changes we made. No need to reference the "old" way in the blog post. approach it like it's a new post that I'm writing on how to automate local VM provisioning, configure the VMs for lima and configure MongoDB (i work for mongodb) and postgres. Walk the user through what this code/repo is doing. Use inline links and also emojis.

When it comes to code blocks for my blog post don't use ```bash ``` ticks, instead use CODE_START:bash .... CODE_END tags for any code snippets. Again this is just when generating markdown for my blog. You can use ```markdown my blog post content ``` for the actual content so I can copy.
